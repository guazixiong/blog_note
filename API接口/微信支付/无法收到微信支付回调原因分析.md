# 接收不到微信回调通知的解决方法

## 准备工具

* postman

## 什么情况下会产生回调通知

### 1. 支付成功会发送支付结果回调通知

可参考官方文档：[支付通知API](https://pay.weixin.qq.com/wiki/doc/apiv3/apis/chapter3_1_5.shtml)

### 2. 申请退款成功后，只有退款状态为**退款异常、退款关闭、退款成功**才会发送退款回调通知

可参考官方文档：[退款结果通知API](https://pay.weixin.qq.com/wiki/doc/apiv3/apis/chapter3_1_11.shtml)

### 注意：

1.上面只是举例了两个接口，还要更多的回调接口，每个回调接口都会有对应的 ***通知频率*** 和 ***回调触发条件***

2.***支付结果回调*** 是异步队列加公网通知的，***支付完成后会立即发送回调消息***，以支付结果回调为准，不存在回调支付成功，查询接口却一直返回的是未支付

3.***退款回调*** 是**异步**的，申请退款接口返回的成功只是代表了申请退款这个操作成功了，退款整个流程可能经过银行等，所以 ***回调时长可能会长一些***

4.申请退款成功后，用户侧长时间未到账，或商户查询退款状态一直都是退款中，则可能是退款到用户银行卡中，需要经过银行，一般在7个工作内是比较正常的，若7个工作日后还是退款中，请拨打95017协助排查

5.回调的作用是告诉商户结果是什么，商户应答回调是告诉接口已经成功收到回调，***建议商户最好是按照文档要求去应答接口***，若商户是自行查询接口来判断情况，而不是根据回调来判断，理论上是可以不去管回调（包括应答），但还是强烈建议按照正常流程正确的应答接口

## 无法接收回调的情况及对应的检查方法

### 情况一: v3接口能支付成功，未设置APIv3密钥则无法收到回调

![](%E6%97%A0%E6%B3%95%E6%94%B6%E5%88%B0%E5%BE%AE%E4%BF%A1%E6%94%AF%E4%BB%98%E5%9B%9E%E8%B0%83%E5%8E%9F%E5%9B%A0%E5%88%86%E6%9E%90.assets/202305102219999.png)

> 注意（APIv2密钥以前也叫API密钥）：
> 
> + ***v2接口*** 使用的是 ***APIV2密钥***，v2接口 ***下单能成功*** 说明就设置好了APIv2密钥。
> 
> + ***APIv3密钥*** 与 ***APIV2密钥*** 是隔离的，设置APIv3密钥时，不会导致APIV2密钥发生变化，且 ***对v2接口没有影响***。

### 情况二: 本地v3接口支付成功，回调地址填写错误

+ 回调地址填写格式问题
  
  + 域名`https://www.qqweixin.top/weixin/pay/callback/test`
  
  + ip `http://118.168.1.33/weixin/pay/callback/test`
  
  + **域名 和 ip 都需要使用可以被外网访问,即DNS解析成功**
    ![](%E6%97%A0%E6%B3%95%E6%94%B6%E5%88%B0%E5%BE%AE%E4%BF%A1%E6%94%AF%E4%BB%98%E5%9B%9E%E8%B0%83%E5%8E%9F%E5%9B%A0%E5%88%86%E6%9E%90.assets/202305102218597.png)

+ 修改回调地址后,重复请求支付成功订单接口,原回调地址不改变
  
  > 支付订单A
  > 
  > 本地测试v3接口,回调地址`http://127.0.0.1/wx/pay/v3/payCallback`
  > 
  > 服务器部署后,回调地址`http://xxx.xxx.xxx.xxx/wx/pay/v3/payCallback`
  > 
  > 再次对支付订单A请求支付接口,请求成功,但回调地址仍为`http://127.0.0.1/wx/pay/v3/payCallback`

### 情况三: 本地开通了防护墙,拦截了回调

是否开通了防火墙导致回调地址被拦截了，开通防火墙后设置一下白名单，[回调IP段白名单](https://pay.weixin.qq.com/wiki/doc/api/jsapi.php?chapter=23_8&index=6)

### 情况四: 商户侧网络波动导致部分回调丢失

1.一般商户侧出现就部分订单的回调丢失就是这种情况，微信侧目前没有出现过支付成功后未给商户发送回调的情况，若极端情况下出现，官方也肯定是会在第一时间通知商户，所以基本都是商户自身网络问题导致  
[网络排查工具](https://pay.weixin.qq.com/wiki/doc/api/jsapi.php?chapter=23_2&index=3)

2.商户业务层已经对回调处理完成并成功应答， 但商户侧自身系统问题，导致这条回调数据丢失，需要商户自身排查

### 情况五: 程序代码问题(若使用的回调地址本身是在正常使用的回调地址，是对代码或者环境修改后出现的问题，则说明是代码层面或者环境的问题）

使用postman等API调试工具模拟微信支付回调的格式测试，检查代码是否能正常接收回调信息，**v2接口的回调信息是xml格式，v3接口的回调格式json格式**，上述两种格式都是以字符串的形式发送的数据流，

> 特殊情况：只要是在商户平台进行 手动退款的回调通知都是xml格式。

（注意测试时，发送回调和接收回调尽量不要在同一网络当中，避免都是在是同一网络测试结果不准确，注意：接收到回调为空的现象一般都是接收格式的问题，比如xml格式的数据使用json格式接收）

## 情况七：域名（url）转发导致的DNS解析失败

域名转发：所谓域名（url）转发，是通过服务器的特殊设置，将访问您当前域名的用户引导到您指定的另一个网络地址。 地址转向（也可称“URL转发”）即将一个域名指向到另外一个已存在的站点，英文称为“ URL FORWARDING ”。

 **DNS解析失败：解析失败就是找不到相关域名对应的IP**

这种情况一般自己比较难排查吗，所以不要做域名转发，然后再进行测试，出现问题后再按照上述步骤进行检查（***建议直接咨询自己的运维人员，他们知道如何处理***）
