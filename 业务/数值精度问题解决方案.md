# **数值精度问题解决方案**

1. **四舍六入五成双**
2. **数据兜底处理**
3. **扣除兜底误差处理**
4. **模拟用户计算流程**

## 精度问题处理方式

### 四舍六入五成双

四舍六入五成双是一种比较精确比较科学的计数保留法，是一种数字修约规则。

> 算法规则:四舍六入五考虑，五后非零就进一，五后皆零看奇偶，五前为偶应舍去， 五前为奇要进一。

### 数据兜底处理

**当一个数据D拆分成M个数据时，前M-1个数据根据四舍五入做处理，第M个数据=D-前M-1个数据之和。**

### 余额扣除兜底误差处理

**余额扣除时，可能扣除数字是通过计算所得，多次合计之后不等于余额，存在很小的误差，因此当误差小于指定值时默认置为0；** 

**误差界限值：当数字保留两位时，界限值为0.01；当数字保留3位时，界限值为0.001。**

**依此类推：1 / 10(保留位数 阶乘)**

### 模拟用户计算流程

**计算过程按照用户计算习惯进行处理**

## 案例

### 例1

商户M收到一笔钱1234.5块，需要将这笔钱分别按35%、65% 的比例分给门店A、B。

若计算结果按四舍五入保留2位小数。

分账前总金额：1234.5元

**四舍五入**

> 门店A：1234.5×35%=432.075≈432.08；
>
> 门店B：1234.5×65%=802.425≈802.43；
>
> 分账后总金额：1234.51元
>
> 分账前总金额 < 分账后总金额；

**四舍六入五成双**

> 门店A：1234.5×35%=432.075≈432.08；
>
> 门店B：1234.5×65%=802.425≈802.42；
>
> 分账后总金额：1234.5元
>
> 分账前总金额 = 分账后总金额；

**数据兜底**

> 门店A：1234.5×35%=432.075≈432.08；
>
> 门店B：1234.5 - 432.08 = 802.42
>
> 分账后总金额：1234.5元
>
> 分账前总金额 = 分账后总金额；

### 例2

商户M收到一笔钱1111.11块，需要将这笔钱分别按30%、30% 、40%的比例分给门店A、B、C。

若计算结果按四舍五入保留2位小数。

分账前总金额：1111.11元

**四舍五入**

> 门店A：1111.11×30%=333.333≈333.33；
>
> 门店B：1111.11×30%=333.333≈333.33；·
>
> 门店C：1111.11×40%=444.44≈444.44；
>
> 分账后总金额：1111.10元
>
> 分账前总金额 > 分账后总金额；

**四舍六入五成双**

> 门店A：1111.11×30%=333.333≈333.33；
>
> 门店B：1111.11×30%=333.333≈333.33；
>
> 门店C：1111.11×40%=444.44≈444.44；
>
> 分账后总金额：1111.10元
>
> 分账前总金额 > 分账后总金额；

**数据兜底**

> 门店A：1111.11×30%=333.333≈333.33；
>
> 门店B：1111.11×30%=333.333≈333.33；·
>
> 门店C：1111.11 - 333.33 - 333.33 =444.45；
>
> 分账后总金额：1111.11元
>
> 分账前总金额 = 分账后总金额；

### 例3

> 付款申请单  申请付款金额：2130.76， 
>
> 关联结算单1：1437.67， 
>
> 关联结算单2：693.09；
>
> 本次付款金额：2130.76
>
> 关联结算单1付款金额：1437.67/2130.7 = 0.6747216955       2130.76 * 0.6747407 = 1437.669999903580
>
> 应付款：1437.67  减去 1437.669999903580  误差小于0.01

## 总结

数据兜底：常用于均摊处理，所有数据可取的情况。优先使用