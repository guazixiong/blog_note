# RabbitMQ延时队列

- 存储到数据库，用定时任务扫描，登记时刻+延时时间，就是需要投递的时刻
- 利用**RabbitMQ的死信队列（Dead Letter Queue）**实现
  - 利用**RabbitMQ设置过期队列,并发送到死信队列**
  - 利用**RabbitMQ设置普通队列消息过期时间,并发送到死信队列**
- 利用`rabbitmq-delayed-message-exchange`插件

## 数据库存储,设置定时任务

## RabbitMQ死信队列

生产者——延时交换机——延时队列——（超过TTL之后）——死信交换机——死信队列——最终消费者

![img](RabbitMQ%E5%BB%B6%E6%97%B6%E9%98%9F%E5%88%97.assets/202303261214023.jpeg)

使用死信队列实现延时消息的缺点：

1. 如果统一用队列来设置消息的TTL，当梯度非常多的情况下，比如1分钟，2分钟，5分钟，10分钟，20分钟，30分钟……需要创建很多交换机和队列来路由消息。
2. 如果单独设置消息的TTL，则可能会造成队列中的消息阻塞——前一条消息没有出队（没有被消费），后面的消息无法投递。
3. 可能存在一定的时间误差。

## rabbitmq-delayed-message-exchange